---
title: "nestling-temp-cort-final"
author: "Erica Griffin"
date: "2025-11-23"
output: html_document
---

# Environmental effects on corticosterone in nestling tree swallows

### Last updated: November 17, 2025

## Abstract:

For an individual, the ability to cope with challenges is fundamental to surviving in a changing environment. The corticosterone stress response has a major impact on the ability of an organism to react to the challenges of rapid environmental change. Previous research has shown that when faced with a prolonged cold snap, adult female tree swallows increase their baseline and stress-induced corticosterone levels, and that individual variation in corticosterone levels predicts reproductive success during challenges. Tree swallows are advancing reproduction with warming springs and are more likely to encounter cold snaps during breeding, which can reduce reproductive success. Here, using data from a long-term study of free-living tree swallows collected from 2013-2025, we show that nestling tree swallows show an immediate increase in corticosterone levels when ambient temperatures fall below a threshold of 18.5째C, which has previously been identified as the threshold at which insect availability begins to decline. As a result of earlier reproduction, nestlings are more likely to experience cold snaps during development, making it especially important to understand their effects. Ongoing work is also testing whether male and female nestlings display dimorphism in their corticosterone responses to further our understanding of how nestlings are responding to thermal environmental shifts.

## Research Questions:

1)  How does temperature influence nestling corticosterone levels?
2)  Do male and female nestlings differ in their corticosterone regulation?
3)  Does sex mediate the effect of temperature on the corticosterone response in nestlings?

## Hypotheses:

1)  Lower temperatures during developmental periods lead to increased corticosterone responses;
2)  Corticosterone regulation in nestlings will be mediated by sex; and
3)  lower temperatures during developmental periods induce sex-specific effects on the stress response in nestling tree swallows.

## Predictions:

Hypothesis 1: Temperature will show a negative relationship with baseline and stress-induced corticosterone, with there being an increase in these measures when both average daily temperatures and average 3-day temperatures are lower; Temperature will have no relationship with post-dex corticosterone levels.

Hypothesis 2: Males and females will show base differences in their corticosterone regulation, with females showing lower corticosterone across all measures, based on previous studies done in adult birds (baseline corticosterone, stress-induced corticosterone, and post-dex corticosterone).

Hypothesis 3:Females will showcase a stronger corticosterone response (across all measures) in response to lower temperatures, consistent with prior work in our population showing that females may more sensitive to some stressors. 


```{r setup, include=FALSE}
pacman::p_load(gamm4, dplyr, lme4, MASS, lmerTest, here, DHARMa, MuMIn, mgcv, ggplot2, gratia, patchwork, ggeffects) # load packages 

weather_df <- read.csv(here("IntermediateData", "weather_df.csv")) # load in data that was produced by scripts in the DataCuration code 
weather_df$log_bleed1_final_cort <- log(weather_df$bleed1_final_cort) # log transform cort measures 
weather_df$log_bleed2_final_cort <- log(weather_df$bleed2_final_cort)
weather_df$log_bleed3_final_cort <- log(weather_df$bleed3_final_cort)
sex_df <- read.csv(here("IntermediateData", "9-19-25_data.csv")) # load in data that was produced by scripts in the DataCuration code  

sex <- factor(sex_df$sex)
sex_df$log_bleed1_final_cort <- log(sex_df$bleed1_final_cort) # log transform cort 
sex_df$log_bleed2_final_cort <- log(sex_df$bleed2_final_cort)
sex_df$log_bleed3_final_cort <- log(sex_df$bleed3_final_cort)
sex_df$sex <- as.factor(sex_df$sex) # convert sex to a factor for GAMMS

 # set colors for figures : ) from the color blind friendly palette Accent (https://journal.r-project.org/articles/RJ-2023-071/; https://emilhvitfeldt.github.io/r-color-palettes/discrete/RColorBrewer/Accent/)

base_color <- "#386CB0FF"
stress_color <- "#BEAED4FF"
dex_color <- "#FDC086FF"


male_color = "#FDC086FF" # maybe change these? 
female_color = "#386CB0FE"
```

# Question 1: How does temperature influence nestling corticosterone levels?

In this section, I am running GAMM models, as based on prior checking, the effect of temperature on corticosterone is non-linear, and a smooth term fits the data better than a linear term. Average daily temperature is used as the predictor, as this seemed to have a slightly stronger effect than average 3 day temperature, and all corticosterone measures have been log-transformed to conform to a normal distribution better. 

## Baseline corticosterone

```{r}
bleed1_weather_gamm4 <- gamm4( # run gamm model 
  log_bleed1_final_cort ~ s(avgC_capture_day) + (bleed1_latency_sec),
  random = ~(1 | nest_key),
  data = weather_df
)
summary(bleed1_weather_gamm4$gam) # view results of gam 
summary(bleed1_weather_gamm4$mer) # view random effects 
plot(bleed1_weather_gamm4$gam, pages = 1) # view smooth term 
k.check(bleed1_weather_gamm4$gam) # check the k to see if the model is "wiggly" enough 
par(mfrow = c(2, 2))
gam.check(bleed1_weather_gamm4$gam) # check residuals to make sure model is normal 

```

```{r}

base_cort <- draw(bleed1_weather_gamm4$gam, term = "avgC_capture_day")$data %>%
  dplyr::select(avgC_capture_day = avgC_capture_day, fit = .estimate, se = .se, cil = .lower_ci, ciu = .upper_ci)

base_cort_plot <- ggplot() +
  geom_abline(slope = 0, intercept = 0, linetype = "61", color = "gray75", size = 0.3) +
  geom_line(data = base_cort, aes(x = avgC_capture_day, y = fit), color = base_color, linetype = "solid", size = 0.3) +
  geom_ribbon(data = base_cort, aes(x = avgC_capture_day, ymin = cil, ymax = ciu), fill = base_color, alpha = 0.4) +
   labs(x = NULL, y = "Predicted Partial Baseline Corticosterone") +
  theme_classic() +
  scale_x_continuous(breaks = seq(0, 30, 10)) +
  xlim(c(13, 30)) +
  theme(panel.grid = element_blank(), axis.text = element_text(size = 12), axis.title = element_text(size = 14), plot.margin = margin(15, 15, 15, 15))
base_cort_plot
```

## Stress-induced corticosterone

```{r}
bleed2_weather_gamm4 <- gamm4( # run gamm model 
  log_bleed2_final_cort ~ s(avgC_capture_day) + (log_bleed1_final_cort),
  random = ~(1 | nest_key),
  data = weather_df
)
summary(bleed2_weather_gamm4$gam) # view results of gam 
summary(bleed2_weather_gamm4$mer) # view random effects 
plot(bleed2_weather_gamm4$gam, pages = 1) # view smooth term 
k.check(bleed2_weather_gamm4$gam) # check the k to see if the model is "wiggly" enough 
par(mfrow = c(2, 2))
gam.check(bleed2_weather_gamm4$gam) # check residuals to make sure model is normal 
```

```{r}

stress_cort <- draw(bleed2_weather_gamm4$gam, term = "avgC_capture_day")$data %>%
  dplyr::select(avgC_capture_day = avgC_capture_day, fit = .estimate, se = .se, cil = .lower_ci, ciu = .upper_ci)

stress_cort_plot <- ggplot() +
  geom_abline(slope = 0, intercept = 0, linetype = "61", color = "gray75", size = 0.3) +
  geom_line(data = stress_cort, aes(x = avgC_capture_day, y = fit), color = stress_color, linetype = "solid", size = 0.3) +
  geom_ribbon(data = stress_cort, aes(x = avgC_capture_day, ymin = cil, ymax = ciu), fill = stress_color, alpha = 0.4) +
  labs(x = NULL, y = "Predicted Partial Stress-Induced Corticosterone") +
  theme_classic() +
  scale_x_continuous(breaks = seq(0, 30, 10)) +
  xlim(c(13, 30)) +
  theme(panel.grid = element_blank(), axis.text = element_text(size = 12), axis.title = element_text(size = 14), plot.margin = margin(15, 15, 15, 15))

stress_cort_plot
```


## Dex corticosterone

```{r}
bleed3_weather_gamm4 <- gamm4( # run gamm model 
  log_bleed3_final_cort ~ s(avgC_capture_day) + (log_bleed1_final_cort),
  random = ~(1 | nest_key),
  data = weather_df
)
summary(bleed3_weather_gamm4$gam) # view results of gam 
summary(bleed3_weather_gamm4$mer) # view random effects 
plot(bleed3_weather_gamm4$gam, pages = 1) # view smooth term
k.check(bleed3_weather_gamm4$gam) # check the k to see if the model is "wiggly" enough 
par(mfrow = c(2, 2))
gam.check(bleed3_weather_gamm4$gam) # check residuals to make sure model is normal  
```

```{r}

dex_cort <- draw(bleed3_weather_gamm4$gam, term = "avgC_capture_day")$data %>%
  dplyr::select(avgC_capture_day = avgC_capture_day, fit = .estimate, se = .se, cil = .lower_ci, ciu = .upper_ci)

dex_cort_plot <- ggplot() +
  geom_abline(slope = 0, intercept = 0, linetype = "61", color = "gray75", size = 0.3) +
  geom_line(data = dex_cort, aes(x = avgC_capture_day, y = fit), color = dex_color, linetype = "solid", size = 0.3) +
  geom_ribbon(data = dex_cort, aes(x = avgC_capture_day, ymin = cil, ymax = ciu), fill = dex_color, alpha = 0.4) +
  labs(x = NULL, y = "Predicted Partial Post-Dex Corticosterone") +
  theme_classic() +
  scale_x_continuous(breaks = seq(0, 30, 10)) +
  xlim(c(13, 30)) +
  theme(panel.grid = element_blank(), axis.text = element_text(size = 12), axis.title = element_text(size = 14), plot.margin = margin(15, 15, 15, 15),
)


dex_cort_plot

```

Combine all plots together
```{r}
combined <- base_cort_plot | stress_cort_plot | dex_cort_plot  # one row
final_figure1 <- combined + plot_annotation(
  caption = ("Average Daily Temperature (째C)")
) &
theme(
    plot.caption = element_text(hjust = 0.5, size = 14) 
  )
final_figure1
ggsave("TablesFigures/Figure1.png",
       plot = final_figure1, height = 5, width = 14)
```

# Question 2: Do male and female nestlings differ in their corticosterone regulation

Here, I am just using regular linear mixed models to determine if there are any sex differences. 

## Baseline corticosterone

```{r}
bleed1_sex <- lmer(log_bleed1_final_cort ~ sex + bleed1_latency_sec + ( 1 | nest_key), data = sex_df)
summary(bleed1_sex)
```

```{r}
simulationOutput = simulateResiduals(bleed1_sex, plot = F)
plot(simulationOutput)
testDispersion(simulationOutput)
```

## Stress-induced corticosterone

```{r}
bleed2_sex <- lmer(log_bleed2_final_cort ~ sex + log_bleed1_final_cort + ( 1 | nest_key), data = sex_df)
summary(bleed2_sex)
```

```{r}
simulationOutput = simulateResiduals(bleed2_sex, plot = F)
plot(simulationOutput)
testDispersion(simulationOutput)
```

## Post-dex corticosterone

```{r}
bleed3_sex <- lmer(log_bleed3_final_cort ~ sex + log_bleed1_final_cort + ( 1 | nest_key), data = sex_df)
summary(bleed3_sex)
```

```{r}
simulationOutput = simulateResiduals(bleed3_sex, plot = F)
plot(simulationOutput)
testDispersion(simulationOutput)
```

# Question 3: Does sex mediate the effect of temperature on the corticosterone response in nestlings?

Here, I will be using GAM agains to fit that smooth term effect of temp on cort, to stay consistent with the first set of models. 

## Baseline corticosterone

```{r}
bleed1_int_gamm <- gamm4(
  log_bleed1_final_cort ~ sex + s(avgC_capture_day, by = sex) + (bleed1_latency_sec),
  random = ~(1 | nest_key),
  data = sex_df)
summary(bleed1_int_gamm$gam)
summary(bleed1_int_gamm$mer)
plot(bleed1_int_gamm$gam, pages = 1) # view smooth term 

k.check(bleed1_int_gamm$gam) # check the k to see if the model is "wiggly" enough 
par(mfrow = c(2, 2))
gam.check(bleed1_int_gamm$gam) # check residuals to make sure model is normal 
```

```{r}
pred_base <- ggpredict(bleed1_int_gamm, 
                         terms = c("avgC_capture_day [all]", "sex [Female, Male]"))

base_int <- ggplot(pred_base, aes(x = x, y = predicted, color = group, fill = group)) +
  geom_abline(slope = 0, intercept = 0, linetype = "61", color = "gray75", size = 0.3) +
  geom_line(size = 1.0) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.4, color = NA) +
  labs(x = NULL, y = "Predicted Baseline Corticosterone") +
  theme_classic() +
  theme(
    panel.grid = element_blank(),
    axis.text  = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.title = element_blank(),
    legend.position = "top") +
  scale_color_manual(values = c(Female = female_color, Male = male_color))+
  scale_fill_manual(values = c(Female = female_color, Male = male_color))+
  scale_x_continuous(breaks = seq(13, 30, 5))
base_int
```

## Stress-induced corticosterone

```{r}
bleed2_int_gamm <- gamm4(
  log_bleed2_final_cort ~ sex + s(avgC_capture_day, by = sex) + (log_bleed1_final_cort),
  random = ~(1 | nest_key),
  data = sex_df)
summary(bleed2_int_gamm$gam)
summary(bleed2_int_gamm$mer)
plot(bleed2_int_gamm$gam, pages = 1) # view smooth term 

k.check(bleed2_int_gamm$gam) # check the k to see if the model is "wiggly" enough 
par(mfrow = c(2, 2))
gam.check(bleed2_int_gamm$gam) # check residuals to make sure model is normal 
```

```{r}

pred_stress <- ggpredict(bleed2_int_gamm, 
                       terms = c("avgC_capture_day [all]", "sex [Female, Male]"))



stress_int <- ggplot(pred_stress, aes(x = x, y = predicted, color = group, fill = group)) +
  geom_abline(slope = 0, intercept = 0, linetype = "61", color = "gray75", size = 0.3) +
  geom_line(size = 1.0) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.4, color = NA) +
  labs(x = NULL, y = "Predicted Stress-Induced Corticosterone") +
  theme_classic() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_blank(),
        legend.position = "top") +
  scale_color_manual(values = c(Female = female_color, Male = male_color))+
  scale_fill_manual(values = c(Female = female_color, Male = male_color))+
  scale_x_continuous(breaks = seq(13, 30, 5))

stress_int

```

## Post-dex corticosterone

```{r}
bleed3_int_gamm <- gamm4(
  log_bleed3_final_cort ~ sex + s(avgC_capture_day, by = sex) + (log_bleed1_final_cort),
  random = ~(1 | nest_key),
  data = sex_df)
summary(bleed3_int_gamm$gam)
summary(bleed3_int_gamm$mer)
plot(bleed3_int_gamm$gam, pages = 1) # view smooth term 


k.check(bleed3_int_gamm$gam) # check the k to see if the model is "wiggly" enough 
par(mfrow = c(2, 2))
gam.check(bleed3_int_gamm$gam) # check residuals to make sure model is normal 
```

```{r}

pred_dex <- ggpredict(bleed3_int_gamm, 
                         terms = c("avgC_capture_day [all]", "sex [Female, Male]"))



dex_int <- ggplot(pred_dex, aes(x = x, y = predicted, color = group, fill = group)) +
  geom_abline(slope = 0, intercept = 0, linetype = "61", color = "gray75", size = 0.3) +
  geom_line(size = 1.0) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.4, color = NA) +
  labs(x = NULL, y = "Predicted Post-dex Corticosterone") +
  theme_classic() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_blank(),
        legend.position = "top") +
  scale_color_manual(values = c(Female = female_color, Male = male_color))+
  scale_fill_manual(values = c(Female = female_color, Male = male_color))+
  scale_x_continuous(breaks = seq(13, 30, 5))

dex_int
```

Combine all together

```{r}

combined2 <- base_int | stress_int | dex_int  # one row

final_figure2 <- combined2 + plot_annotation(
  caption = ("Average Daily Temperature (째C)")
) &
  theme(
    plot.caption = element_text(hjust = 0.5, size = 14) 
  )
final_figure2

ggsave("TablesFigures/Figure2.png",
       plot = final_figure2, height = 5, width = 14)
```

### Female / Male Comparision Plots 

Now, creating a figure to compare the smooths in the interaction models, based on this tutorial: this tutorial:https://fromthebottomoftheheap.net/2017/10/11/difference-splines-i/ 

Run function from above site: 

```{r}
smooth_diff <- function(model, newdata, f1, f2, var, alpha = 0.05,
                        unconditional = FALSE) {
  fac <- as.character(newdata[[var]]) # added this to convert sex to a character to allow for comparision
  xp <- predict(model, newdata = newdata, type = 'lpmatrix')
  c1 <- grepl(f1, colnames(xp))
  c2 <- grepl(f2, colnames(xp))
  r1 <- fac == f1 # modified this
  r2 <- fac == f2
  ## difference rows of xp for data from comparison
  X <- xp[r1, ] - xp[r2, ]
  ## zero out cols of X related to splines for other lochs
  X[, ! (c1 | c2)] <- 0
  ## zero out the parametric cols
  X[, !grepl('^s\\(', colnames(xp))] <- 0
  dif <- X %*% coef(model)
  se <- sqrt(rowSums((X %*% vcov(model, unconditional = unconditional)) * X))
  crit <- qt(alpha/2, df.residual(model), lower.tail = FALSE)
  upr <- dif + (crit * se)
  lwr <- dif - (crit * se)
  data.frame(pair = paste(f1, f2, sep = '-'),
             diff = dif,
             se = se,
             upper = upr,
             lower = lwr)
}
```

Create dataframe to be fed into the function:

```{r}

pdat_base <- expand.grid(
  avgC_capture_day = seq(13.5, 28.5, length = 400),
  sex = c("Female", "Male"),
  bleed1_latency_sec = mean(sex_df$bleed1_latency_sec, na.rm = TRUE)
)

pdat_stress_dex <- expand.grid(
  avgC_capture_day = seq(13.5, 28.5, length = 400),
  sex = c("Female", "Male"),
  log_bleed1_final_cort = mean(sex_df$log_bleed1_final_cort, na.rm = TRUE)
)
```

```{r}
comp_base <- smooth_diff(bleed1_int_gamm$gam, pdat_base, 'Female', 'Male', 'sex')
comp_base$avgC_capture_day <- pdat_base$avgC_capture_day[pdat_base$sex == "Female"]
comp_stress <- smooth_diff(bleed2_int_gamm$gam, pdat_stress_dex, 'Female', 'Male', 'sex')
comp_stress$avgC_capture_day <- pdat_stress_dex$avgC_capture_day[pdat_stress_dex$sex == "Female"]
comp_dex <- smooth_diff(bleed3_int_gamm$gam, pdat_stress_dex, 'Female', 'Male', 'sex')
comp_dex$avgC_capture_day <- pdat_stress_dex$avgC_capture_day[pdat_stress_dex$sex == "Female"]
```
Create plots: 

## Baseline Corticosterone
```{r}
base_diff <- ggplot(comp_base, aes(x = avgC_capture_day, y = diff)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, fill = base_color) +
  geom_line(size = 1, color = base_color) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  coord_cartesian(ylim = c(-1, 1)) +
  labs(x = NULL, y = 'Difference in Baseline Corticosterone (Female - Male') +
  theme_minimal() +
  theme(
    panel.grid = element_blank()   # removes ALL grid lines
  )
base_diff 
```
## Stress-induced corticosterone
```{r}
stress_diff <- ggplot(comp_stress, aes(x = avgC_capture_day, y = diff)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4, fill = stress_color) +
  geom_line(size = 1, color = stress_color) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  coord_cartesian(ylim = c(-1, 1)) +
  labs(x = NULL, y = 'Difference in Stress-Induced Corticosterone (Female - Male') +
  theme_minimal() +
  theme(
    panel.grid = element_blank()   # removes ALL grid lines
  )
  
stress_diff
```

## Post-dex corticosterone

```{r}
dex_diff <- ggplot(comp_dex, aes(x = avgC_capture_day, y = diff)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4, fill = dex_color) +
  geom_line(size = 1, color = dex_color) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  coord_cartesian(ylim = c(-1, 1)) +
  labs(x = NULL, y = 'Difference in Post-dex Corticosterone (Female - Male') +
  theme_minimal() +
  theme(
    panel.grid = element_blank()   # removes ALL grid lines
  )

dex_diff
```

Create one figure with all combined: 

```{r}
combined3 <- base_diff | stress_diff | dex_diff  # one row

final_figure3 <- combined3 + plot_annotation(
  caption = ("Average Daily Temperature (째C)")
) &
  theme(
    plot.caption = element_text(hjust = 0.5, size = 14) 
  )
final_figure3

ggsave("TablesFigures/Figure3.png",
       plot = final_figure3, height = 5, width = 14)
```

